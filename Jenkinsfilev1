def jira_id_map
pipeline {
    agent any
	tools {
        maven 'localmaven'
    }

	stages{
	
		stage('Input Jira Id') {
			steps {
				script {
					try {
						timeout(time:30, unit:'SECONDS') {
							jira_id_map = input(message: 'Enter Jira Id (or leave blank) and press [Proceed]!!', parameters: [[$class: 'TextParameterDefinition', defaultValue: '', description: '', name: 'Jira Id']], submitterParameter: 'APPROVER')
						}
					} catch (err) {
					
					}
				}
			}
		}
		
		stage('Cleaning') {
			 steps {
				bat 'mvn clean'
            }
		}
		
		stage('Running Unit Tests') {
			 steps {
				bat 'mvn test'
            }
			post {
                failure {
                    echo ' Unit test cases failed. Creating jira ticket.'
                }
            }
		}
		
        stage('Build') {
            steps {
				bat 'mvn clean package'
            }
            post {
                success {
					echo "current build number: ${currentBuild.number}"
					echo ("User has following jira id= " + jira_id_map['Jira Id'].toString().toUpperCase() + ", and is approved by= " + jira_id_map['APPROVER'])
					jiraAddComment comment: 'Build successful. Making deployment to the servers.', idOrKey: jira_id_map['Jira Id'], site: 'localjira'
					echo 'Now Archiving'
                    archiveArtifacts artifacts: '**/target/*.jar'
                }
            }
        }
		
        stage ('Deploy to Staging') {
			steps {
				echo 'Deploying to staging.'
			}
        }
		
		stage ('Deploy to Production') {
            steps {
				echo 'Deploying to production.'
			}
        }
		
    }
}